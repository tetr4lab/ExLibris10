@inherits ItemListBase<Book, Author>

@page "/books"

<PageTitle>ExLibris Books</PageTitle>

@if (items == null) {
    <MudProgressCircular Indeterminate="true" />
} else {
    if (items.Count > 0) {
        <MudTable Items="items" Dense Hover Striped Breakpoint="Breakpoint.Xs" @ref="_table"
            OnRowClick="EventCallback.Factory.Create<TableRowClickEventArgs<Book>> (this, arg => EditItem (arg.Item))"
            Filter="new Func<Book, bool>(FilterFunc)"
            SortLabel="⇅"
            AllowUnsorted=true
            @bind-SelectedItem="selectedItem"
            @bind-SelectedItems="selectedItems" MultiSelection="@allowMultiSelection">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, object>(x=>x.Id)">@Book.Label[nameof(Book.Id)]</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, string?>(x=>x.Title)">@Book.Label[nameof(Book.Title)]</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="@(new Func<Book, string?>(x=>string.Join(',',x.RelatedIds.ConvertAll(i=>$"{i:D5}"))))">@(Book.Label[nameof(Book.Authors)])</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<Book, object>(x=>x.PublishDate ?? new DateTime ())">@(Book.Label [nameof (Book.PublishDate)])</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, string?>(x=>x.Publisher)">@(Book.Label[nameof(Book.Publisher)])</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, string?>(x=>x.Series)">@(Book.Label[nameof(Book.Series)])</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, object>(x=>x.Price)">@(Book.Label[nameof(Book.Price)])</MudTableSortLabel></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Book.Label[nameof(Book.Id)])">@context.Id</MudTd>
                <MudTd DataLabel="@(Book.Label[nameof(Book.Title)])">@context.Title</MudTd>
                <MudTd DataLabel="@(Book.Label[nameof(Book.Authors)])">@(string.Join (", ", context.Authors.OrderBy (a => a.Id).ToList ().ConvertAll (a => a.Name)))</MudTd>
                <MudTd Class="text-nowrap" DataLabel="@(Book.Label[nameof(Book.PublishDate)])">@(context.PublishDate?.ToShortDateString ())</MudTd>
                <MudTd DataLabel="@(Book.Label[nameof(Book.Publisher)])">@context.Publisher</MudTd>
                <MudTd DataLabel="@(Book.Label[nameof(Book.Series)])">@context.Series</MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Book.Label[nameof(Book.Price)])">@($"¥{context.Price:#,0}")</MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="_pageSizeOptions" InfoFormat="{first_item}-{last_item} / {all_items}" RowsPerPageString="行/頁:" />
            </PagerContent>
        </MudTable>
        <MudText Class="mt-2" Typo="Typo.body2" Color="Color.Success">@(DataSet.Valid ? "validated" : "")</MudText>
        <MudToolBar Dense Class="mb-2">
            @*hidden spacer*@
        </MudToolBar>
    } else {
        <MudText>No items found.</MudText>
    }
    <MudAppBar Class="backdrop-blur" Color="Color.Transparent" Dense Bottom="true" Fixed="true">
        <MudTooltip Text="一括削除" Duration="1000">
            <MudSwitch @bind-Value="_allowMultiSelection" LabelPosition="LabelPosition.Start" Color="Color.Primary"><MudIcon Class="mt-3" Size="Size.Medium" Icon="@Icons.Material.Filled.DeleteForever"></MudIcon></MudSwitch>
        </MudTooltip>
        @if (_allowMultiSelection) {
            <MudTooltip Text="チェックされた項目を一括削除" Duration="1000">
                <MudFab Disabled="@(_isDeleting || !allowMultiSelection || selectedItems.Count <= 0 || SessionCounter.Count > 1)" OnClick="DeleteItem" StartIcon="@Icons.Material.Filled.DeleteSweep" Color="Color.Warning" Size="Size.Small" Class="ml-5" />
            </MudTooltip>
            @if (!allowMultiSelection) {
                <MudText Class="ml-2" Typo="Typo.body2">複数の利用者がいる場合は使用できません。</MudText>
            }
            <MudDivider Vertical FlexItem Class="mx-5" />
        }
        <MudSpacer />
        <MudTooltip Text="書籍を追加" Duration="1000">
            <MudFab Disabled="_isAdding" OnClick="AddItem" StartIcon="@Icons.Material.Outlined.Add" Color="Color.Success" Size="Size.Small" />
        </MudTooltip>
    </MudAppBar>
}

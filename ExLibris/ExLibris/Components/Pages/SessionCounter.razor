@implements IDisposable

<MudText Typo="Typo.h5">
    @($"{Count} user{(Count > 1 ? "s" : "")}")
</MudText>

@code {

    /// <summary>インスタンス数</summary>
    public static int Count => _instances.Count;

    /// <summary>インスタンス一覧</summary>
    protected static List<SessionCounter> _instances { get; set; } = new List<SessionCounter> ();

    /// <summary>購読者一覧</summary>
    protected static Dictionary<ComponentBase, Action> _subscribers { get; set; } = new Dictionary<ComponentBase, Action>();

    /// <summary>登録/削除と全体更新</summary>
    protected static void UpdateAll (SessionCounter newOne, bool remove = false) {
        if (_instances.Contains (newOne) == remove) {
            if (remove) {
                _instances.Remove (newOne);
            } else {
                _instances.Add (newOne);
            }
            foreach (var instance in _instances.FindAll (i => i != newOne)) {
                instance.UpdateOne ();
            }
            foreach (var subscriber in new Dictionary<ComponentBase, Action> (_subscribers)) {
                subscriber.Value ();
            }
        }
    }

    /// <summary>購読開始</summary>
    public static void Subscribe (ComponentBase component, Action listener) => _subscribers.Add (component, listener);

    /// <summary>購読解除</summary>
    public static void Unsubscribe (ComponentBase component) => _subscribers.Remove (component);

    /// <summary>初期化</summary>
    protected override void OnInitialized () {
        UpdateAll (this);
        base.OnInitialized ();
    }

    /// <summary>破棄</summary>
    public void Dispose () => UpdateAll (this, remove: true);

    /// <summary>単体更新</summary>
    protected void UpdateOne () => InvokeAsync (StateHasChanged);

}